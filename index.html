// =================================================================================
        // FUNÇÕES DE GERENCIAMENTO E LÓGICA EXISTENTES (ATUALIZADAS)
        // =================================================================================

        // ... (funções loadPatients, savePatients, setActivePatient, clearActivePatient, renderPatientList, selectProtocol permanecem inalteradas) ...

        function recordSession(event) {
            event.preventDefault();
            if (!activePatient || activePatient.protocol.name === 'Nenhum') {
                alert('Selecione um paciente e defina um Protocolo Ativo primeiro.');
                return;
            }

            const sudsStart = parseInt(document.getElementById('sudsStart').value);
            const sudsEnd = parseInt(document.getElementById('sudsEnd').value);
            const intervention = document.getElementById('interventionSelect').value;
            const adaptationNotes = document.getElementById('adaptationNotes').value;

            if (isNaN(sudsStart) || isNaN(sudsEnd) || !intervention) {
                alert('Preencha S.U.D.s inicial, final e a intervenção.');
                return;
            }

            // ===================================================
            // NOVO: IMPLEMENTAÇÃO DO SAFETY GATE (TEPT)
            // ===================================================
            if (activePatient.protocol.name === 'TEPT') {
                const nextSessionNumber = activePatient.protocol.sessionCount + 1;
                
                // 1. Check: Processamento prematuro (antes da Sessão 9)
                if (intervention === 'Exposicao' && nextSessionNumber <= 8) {
                    const confirmProcessamento = confirm(
                        `[SAFETY GATE - TEPT] Atenção! O Protocolo VIP sugere as Sessões 1-8 para ESTABILIZAÇÃO e DESENVOLVIMENTO DE RECURSOS (Fase 1). 
                        
                        Iniciar a EXPOSIÇÃO/PROCESSAMENTO (Fase 2) na Sessão ${nextSessionNumber} pode ser prematuro. 
                        
                        Você confirma que o paciente está estabilizado (ex: consegue usar o Lugar Seguro [cite: 46]) e deseja prosseguir com o Processamento (B.2.1.3)?`
                    );
                    if (!confirmProcessamento) {
                        return; // Cancela o registro se o terapeuta não confirmar
                    }
                }
                
                // 2. Check: Processamento com S.U.D.s alto (alerta)
                if (intervention === 'Exposicao' && sudsStart > 7) {
                    alert(
                        `[ALERTA CLÍNICO] O Processamento do trauma (Exposição) deve preferencialmente ser realizado com S.U.D.s inicial abaixo de 5. 
                        
                        S.U.D.s de ${sudsStart} indica alta ativação. Lembre-se de verificar o acesso aos recursos de estabilização (Lugar Seguro) e garantir o Protocolo de Segurança (B.2.1.3)[cite: 46, 48].`
                    );
                    // Continua, mas com alerta explícito
                }
            }
            // ===================================================

            const sessionData = {
                date: new Date().toISOString().slice(0, 10),
                sessionNumber: activePatient.protocol.sessionCount + 1,
                intervention: intervention,
                sudsStart: sudsStart,
                sudsEnd: sudsEnd,
                notes: adaptationNotes,
            };

            activePatient.protocol.sessionCount++; 
            activePatient.sessionHistory.unshift(sessionData); 
            savePatients();

            alert(`Sessão ${sessionData.sessionNumber} registrada com sucesso! Alívio de S.U.D.s: ${sudsStart} -> ${sudsEnd}.`);

            document.getElementById('recordSessionForm').reset();
            document.getElementById('protocolGuideDisplay').style.display = 'none';
            document.getElementById('protocolGuideDisplay').innerHTML = '';
            
            updateClinicalDashboard();
        }

        function updateClinicalDashboard() {
            if (!activePatient) return;

            const p = activePatient.protocol;
            
            document.getElementById('currentProtocolStatus').textContent = `${p.name} (Fase ${p.phase})`;
            document.getElementById('dashboardSessionCount').textContent = p.sessionCount;
            document.getElementById('dashboardTotalSessions').textContent = p.totalSessions;

            let currentPhase = `Fase ${p.phase}: Adaptação Manual`;
            let nextFocus = 'Revisar B.6 (Flexibilidade)';

            if (p.name === 'TEPT') {
                if (p.sessionCount === 0) {
                     currentPhase = 'Fase 1: Início (Psicoeducação)';
                     nextFocus = 'Psicoeducação / Aliança Terapêutica (B.3.1.1)';
                } else if (p.sessionCount <= 8) {
                    currentPhase = `Fase 1: Estabilização e Preparação (${p.sessionCount}/8)`;
                    nextFocus = 'Desenvolvimento de Recursos (Lugar Seguro, Rede de Apoio)';
                } else if (p.sessionCount <= 16) {
                    currentPhase = `Fase 2: Processamento do Trauma (${p.sessionCount}/16)`;
                    nextFocus = 'Exposição Controlada (B.2.1.3) / Reestruturação (B.3.3)';
                } else {
                    currentPhase = 'Fase 3: Consolidação e Recaída';
                    nextFocus = 'Integração de Ganhos / Plano de Crise (B.6)';
                }
            } else if (p.name === 'DEPRESSAO') {
                 if (p.sessionCount <= 6) {
                    currentPhase = `Fase 1: Ativação e Engajamento (${p.sessionCount}/6)`;
                    nextFocus = 'Ativação Comportamental / Mapeamento de Energia Relacional';
                } else {
                    currentPhase = `Fase 2: Modificação de Padrões (${p.sessionCount}/14)`;
                    nextFocus = 'Imagery Rescripting (Memórias Depressogênicas)';
                }
            }
            
            // ... (restante da função updateClinicalDashboard e renderSudsChart) ...
            
            // O restante das funções da sua aplicação deve ser mantido
        }
